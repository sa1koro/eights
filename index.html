<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Crazy Eights</title>
    <link rel="icon" type="image/png" href="info/icon256a.png">
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="info/icon256.png" sizes="256x256">

    <link rel="stylesheet" href="style.css">

</head>
<body>

    <div id="container">
        <span id="header">
            <span id="result" class="result_screen"></span>
        </span>

        <iframe id="main_applet" class="main_screen"></iframe>

        <span id="footer">
            <span id="menu" class="menu_screen">
                <a id="menu_draw1">Draw +1</a> |
                <a id="menu_draw2">Draw +2</a>
            </span>
        </span>
    </div>

    <script type="text/javascript" src="engine.js"></script>
    <!-- Development -  - /Development -->

    <script type="text/javascript">
        let result_screen = new d1ce.Screen("result_screen");
        let menu_screen = new d1ce.Screen("menu_screen")
        let applet = document.getElementById("main_applet")
        let type_count = 5
        let type_number = 54
        let menu = {
            "1": document.getElementById("menu_draw1"),
            "2": document.getElementById("menu_draw2")
        };

        // Update applet.
        function UpdateApplet(seed = null, face = null, flag = null) {

            // Load dice applet.
            let args = ("&type=" + type_count + "d" + type_number) +
                (seed != null ? "&seed=" + seed : "") +
                (face != null ? "&face=" + face : "") +
                (flag != null ? "&flag=" + flag : "");
            applet.src = "app.html?" + args.slice(1);

            console.log("Applet " +
                        " face=" + face +
                        " flag=" + flag);


            // // Change menu color.
            // Object.keys(menu).forEach((key) => {
            //     if (key == type) {
            //         menu[key].style.color = "#000";
            //     } else {
            //         menu[key].style.color = "#666";
            //     }
            // });

            // Clear result screen.
            result_screen.Clear();
            result_screen.Print("Crazy Eights");
        }

        // Update result screen.
        function UpdateResult(result) {
            result_screen.Clear();
            result_screen.Print(result);
        }

        // Update menu screen.
        function UpdateMenu(menu) {
            menu_screen.Clear();
            menu_screen.Print(menu);
        }

        // Parse type parameter.
        function ParseTypeParams(type) {
            let type_count = 1;
            let type_number = 6;
            if (type && type.match(/(\d*)d(\d*)/)) {
                type.replace(/(\d*)d(\d*)/, (match, p1, p2) => {
                    (match);
                    type_count = p1 > 0 ? Number(p1) : 1;
                    type_number = p2 > 0 ? Number(p2) : 6;
                });
            }
            return [type_count, type_number];
        }

        // Parse face parameter.
        function ParseFaceParams(face) {
            return face && face.split(",").map((n) => isFinite(n) ? Number(n) : 0) || [];
        }

        // Parse flag parameter.
        function ParseFlagParams(flag) {
            return flag && flag.split(",").map((n) => isFinite(n) ? Number(n) : 0) || [];
        }

        // Receiving message params.
        // window.onload = async () => {
        console.log("Wait for receivng message.");

        // On received message from main applet.
        window.addEventListener("message", (evt) => {
            if (evt.source == applet.contentWindow) {
                let message = new d1ce.Params("*", true);
            // while (true) {
            //     await message.WaitUpdatingValue();

                // Parse face parameter.
                faces = ParseFaceParams(message.Value("face"));
                type_count = faces.length;

                // Parse select parameter.
                flag = ParseFlagParams(message.Value("flag"));

                console.log("Received " + message.Value("state") +
                            " face=" + message.Value("face") +
                            " flag=" + message.Value("flag"));

                // Now rolling or undefined dice.
                if (faces.length == 0) {
                    UpdateResult("?");

                // Received flag.
                } else if (flag.length > 0) {
                    let faces_next = [];
                    for (let i = 0; i < faces.length; ++i) {
                        if (!flag[i]) {
                            faces_next.push(faces[i]);
                        }
                    }
                    if (faces_next.length != faces.length) {
                        faces = faces_next;
                        type_count = faces.length;
                        let flag_next = [];
                        UpdateApplet(null, faces.join(','), flag_next);
                    }
                }
            }
        // }
        }, false);

        let flag_next = [];
        UpdateApplet(0, null, flag_next);

        // On click menu.
        Object.keys(menu).forEach((key) => {
            menu[key].onclick = () => {
                if (key > 0) {
                    let face = faces.join(',') + "," + Array.from({length: key}, () => 0).join(',');
                    type_count = faces.length + parseInt(key);
                    let flag_next = [];
                    UpdateApplet(null, face, flag_next);
                } else {
                    let flag_next = [];
                    UpdateApplet(null, null, flag_next);
                }
            }
        });
    </script>

    <script>navigator.serviceWorker.register("worker.js");</script>
</body>
</html>
